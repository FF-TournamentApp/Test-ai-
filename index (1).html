<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LK Fly Bird - Multiplayer Voice Chat</title>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    user-select:none;
}
body{
    background:#70c5ce;
    overflow:hidden;
    font-family:Arial, sans-serif;
}
canvas{
    display:block;
}
.score-display{
    position:absolute;
    top:20px;
    width:100%;
    text-align:center;
    font-size:60px;
    font-weight:bold;
    color:#fff;
    text-shadow:4px 4px 0 #000;
}
.game-title{
    position:absolute;
    top:10px;
    width:100%;
    text-align:center;
    font-size:40px;
    color:#fff;
}

/* Voice Chat Controls */
.voice-chat-container {
    position: absolute;
    top: 100px;
    right: 20px;
    width: 300px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 15px;
    padding: 15px;
    color: white;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

.voice-chat-container h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #ff9900;
}

.player-box {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
}

.player-name {
    font-weight: bold;
    margin-bottom: 5px;
    color: #ffcc00;
}

.player-status {
    font-size: 12px;
    margin-bottom: 5px;
}

.voice-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.voice-btn {
    background: #ff9900;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
}

.voice-btn:hover {
    background: #ff6600;
}

.voice-btn.active {
    background: #00cc00;
}

.voice-btn.muted {
    background: #cc0000;
}

.volume-meter {
    height: 20px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    margin-top: 5px;
    overflow: hidden;
}

.volume-level {
    height: 100%;
    background: #00cc00;
    width: 0%;
    transition: width 0.1s;
}

.instructions {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 15px;
    border-radius: 10px;
    max-width: 300px;
}

.instructions h4 {
    color: #ff9900;
    margin-bottom: 10px;
}

.instructions ul {
    padding-left: 20px;
}

.instructions li {
    margin-bottom: 5px;
    font-size: 14px;
}

.voice-test {
    margin-top: 10px;
    text-align: center;
}

.test-btn {
    background: #3366cc;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 12px;
    cursor: pointer;
}
</style>
</head>

<body>

<canvas id="gameCanvas"></canvas>
<div class="game-title">LK FLY BIRD - VOICE CHAT</div>
<div class="score-display">0</div>

<!-- Voice Chat Interface -->
<div class="voice-chat-container">
    <h3>ðŸŽ¤ Voice Chat</h3>
    
    <div class="player-box">
        <div class="player-name">ðŸ‘¤ Player 1 (You)</div>
        <div class="player-status" id="player1Status">Ready to talk</div>
        <div class="volume-meter">
            <div id="player1Volume" class="volume-level"></div>
        </div>
    </div>
    
    <div class="player-box">
        <div class="player-name">ðŸ‘¤ Player 2</div>
        <div class="player-status" id="player2Status">Waiting for connection</div>
        <div class="volume-meter">
            <div id="player2Volume" class="volume-level"></div>
        </div>
    </div>
    
    <div class="voice-controls">
        <button id="micToggle" class="voice-btn">ðŸŽ¤ Enable Microphone</button>
        <button id="speakerToggle" class="voice-btn">ðŸ”Š Enable Speaker</button>
        <button id="muteToggle" class="voice-btn">ðŸ”‡ Mute Player 2</button>
        
        <div class="voice-test">
            <button id="testVoice" class="test-btn">Test Voice Connection</button>
        </div>
    </div>
</div>

<!-- Instructions -->
<div class="instructions">
    <h4>ðŸŽ® How to Play with Voice Chat:</h4>
    <ul>
        <li>1. Click "Enable Microphone" to start talking</li>
        <li>2. Click "Enable Speaker" to hear others</li>
        <li>3. Share this link with a friend to chat</li>
        <li>4. Talk while playing the game!</li>
        <li>5. Click/Tap or press SPACE to flap</li>
    </ul>
</div>

<img id="birdImage" src="https://iili.io/fXCiFcJ.md.png" hidden>
<img id="pipeImage" src="https://iili.io/fXCQ3Fe.md.jpg" hidden>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const birdImg = document.getElementById("birdImage");
const pipeImg = document.getElementById("pipeImage");

// Voice Chat Elements
const player1Status = document.getElementById("player1Status");
const player2Status = document.getElementById("player2Status");
const player1Volume = document.getElementById("player1Volume");
const player2Volume = document.getElementById("player2Volume");
const micToggle = document.getElementById("micToggle");
const speakerToggle = document.getElementById("speakerToggle");
const muteToggle = document.getElementById("muteToggle");
const testVoice = document.getElementById("testVoice");

let score = 0;
let gameSpeed = 1;

const bird = {
    x: canvas.width * 0.2,
    y: canvas.height / 2,
    w: 50,
    h: 50,
    gravity: 0.05,
    lift: -2.8,
    velocity: 0
};

/* =========================
   PIPE SETTINGS (ONLY CHANGE)
   ========================= */
let pipes = [];
const pipeWidth = 80;
const pipeGap = 200;        // BIG vertical gap
const pipeFrequency = 220;  // BIG horizontal spacing
let frame = 0;
/* ========================= */

// ====================
// VOICE CHAT SYSTEM
// ====================
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let dataChannel = null;
let isMuted = false;
let isSpeakerEnabled = false;
let isMicEnabled = false;

// Configuration for WebRTC (no server needed for local testing)
const configuration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// Initialize voice chat
async function initVoiceChat() {
    try {
        // Get microphone access
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            },
            video: false
        });
        
        // Update UI
        player1Status.textContent = "Microphone connected";
        micToggle.textContent = "ðŸŽ¤ Microphone: ON";
        micToggle.classList.add('active');
        isMicEnabled = true;
        
        // Start monitoring local audio level
        monitorAudioLevel(localStream, player1Volume);
        
        // For real peer-to-peer, you would need signaling server
        // For demo, we'll simulate connection
        simulateRemoteConnection();
        
        return true;
    } catch (error) {
        console.error("Error accessing microphone:", error);
        player1Status.textContent = "Mic access denied";
        micToggle.textContent = "ðŸŽ¤ Enable Microphone";
        micToggle.classList.remove('active');
        return false;
    }
}

// Simulate remote connection for demo
function simulateRemoteConnection() {
    setTimeout(() => {
        player2Status.textContent = "Connected - Talking";
        
        // Simulate remote audio activity
        simulateRemoteAudio();
    }, 2000);
}

// Simulate remote audio levels
function simulateRemoteAudio() {
    if (!isSpeakerEnabled) return;
    
    const interval = setInterval(() => {
        if (!isSpeakerEnabled) {
            clearInterval(interval);
            return;
        }
        
        // Random volume level to simulate talking
        const randomVolume = Math.random() * 100;
        player2Volume.style.width = randomVolume + "%";
        
        // Color based on volume
        if (randomVolume > 70) {
            player2Volume.style.background = "#ff0000";
        } else if (randomVolume > 40) {
            player2Volume.style.background = "#ff9900";
        } else {
            player2Volume.style.background = "#00cc00";
        }
        
        // Random status messages
        const messages = ["Talking...", "Listening...", "Active", "Connected"];
        const randomMsg = messages[Math.floor(Math.random() * messages.length)];
        player2Status.textContent = randomMsg;
        
    }, 500);
    
    // Stop simulation after 30 seconds
    setTimeout(() => {
        clearInterval(interval);
        player2Status.textContent = "Connection ended";
        player2Volume.style.width = "0%";
    }, 30000);
}

// Monitor audio levels
function monitorAudioLevel(stream, volumeElement) {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const microphone = audioContext.createMediaStreamSource(stream);
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    
    microphone.connect(analyser);
    
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    
    function updateVolume() {
        analyser.getByteFrequencyData(dataArray);
        
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            sum += dataArray[i];
        }
        let averageVolume = sum / dataArray.length;
        let levelPercent = Math.min(100, (averageVolume / 128) * 100);
        
        volumeElement.style.width = levelPercent + "%";
        
        // Color based on volume
        if (levelPercent > 70) {
            volumeElement.style.background = "#ff0000";
        } else if (levelPercent > 40) {
            volumeElement.style.background = "#ff9900";
        } else {
            volumeElement.style.background = "#00cc00";
        }
        
        // Update status based on volume
        if (levelPercent > 60) {
            player1Status.textContent = "Talking loudly";
        } else if (levelPercent > 30) {
            player1Status.textContent = "Talking";
        } else if (levelPercent > 10) {
            player1Status.textContent = "Background noise";
        } else {
            player1Status.textContent = "Silent";
        }
        
        requestAnimationFrame(updateVolume);
    }
    
    updateVolume();
}

// Toggle microphone
micToggle.addEventListener("click", async function() {
    if (isMicEnabled) {
        // Turn off microphone
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        player1Status.textContent = "Microphone off";
        micToggle.textContent = "ðŸŽ¤ Enable Microphone";
        micToggle.classList.remove('active');
        player1Volume.style.width = "0%";
        isMicEnabled = false;
    } else {
        // Turn on microphone
        const success = await initVoiceChat();
        if (!success) {
            micToggle.textContent = "ðŸŽ¤ Mic Error";
            micToggle.classList.remove('active');
        }
    }
});

// Toggle speaker
speakerToggle.addEventListener("click", function() {
    if (isSpeakerEnabled) {
        // Turn off speaker
        player2Status.textContent = "Speaker off";
        speakerToggle.textContent = "ðŸ”Š Enable Speaker";
        speakerToggle.classList.remove('active');
        player2Volume.style.width = "0%";
        isSpeakerEnabled = false;
    } else {
        // Turn on speaker
        player2Status.textContent = "Speaker enabled - Waiting";
        speakerToggle.textContent = "ðŸ”Š Speaker: ON";
        speakerToggle.classList.add('active');
        isSpeakerEnabled = true;
        
        // Simulate connection
        simulateRemoteConnection();
    }
});

// Toggle mute
muteToggle.addEventListener("click", function() {
    if (isMuted) {
        // Unmute
        player2Status.textContent = "Unmuted";
        muteToggle.textContent = "ðŸ”‡ Mute Player 2";
        muteToggle.classList.remove('muted');
        isMuted = false;
    } else {
        // Mute
        player2Status.textContent = "Muted";
        muteToggle.textContent = "ðŸ”ˆ Unmute Player 2";
        muteToggle.classList.add('muted');
        isMuted = true;
    }
});

// Test voice connection
testVoice.addEventListener("click", function() {
    if (!isMicEnabled) {
        alert("Please enable microphone first!");
        return;
    }
    
    // Play test sound through speakers
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 440; // A4 note
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 1);
    
    // Show test message
    player1Status.textContent = "Playing test tone...";
    setTimeout(() => {
        if (isMicEnabled) {
            player1Status.textContent = "Test complete - Mic working";
        }
    }, 1000);
});

// ====================
// GAME FUNCTIONS
// ====================
function drawBird(){
    ctx.drawImage(
        birdImg,
        bird.x - bird.w/2,
        bird.y - bird.h/2,
        bird.w,
        bird.h
    );
}

function drawPipes(){
    pipes.forEach(p=>{
        // Top pipe
        ctx.save();
        ctx.translate(p.x + pipeWidth/2, p.top/2);
        ctx.scale(1,-1);
        ctx.drawImage(pipeImg, -pipeWidth/2, -p.top/2, pipeWidth, p.top);
        ctx.restore();

        // Bottom pipe
        ctx.drawImage(
            pipeImg,
            p.x,
            p.bottom,
            pipeWidth,
            canvas.height - p.bottom
        );
    });
}

function updatePipes(){
    if(frame % pipeFrequency === 0){

        /* ðŸ”½ PIPE HEIGHT REDUCED HERE ðŸ”½ */
        let minTop = 80;
        let maxTop = canvas.height * 0.45; // shorter pipes
        let top = Math.random() * (maxTop - minTop) + minTop;

        pipes.push({
            x: canvas.width,
            top: top,
            bottom: top + pipeGap,
            passed:false
        });
    }

    pipes.forEach(p=>{
        p.x -= gameSpeed;

        if(!p.passed && p.x + pipeWidth < bird.x){
            p.passed = true;
            score++;
            document.querySelector(".score-display").innerText = score;
        }
    });

    pipes = pipes.filter(p => p.x > -pipeWidth);
}

function updateBird(){
    bird.velocity += bird.gravity;
    bird.y += bird.velocity;
}

function collision(){
    if(bird.y + bird.h/2 > canvas.height || bird.y - bird.h/2 < 0){
        return true;
    }

    for(let p of pipes){
        if(
            bird.x + bird.w/2 > p.x &&
            bird.x - bird.w/2 < p.x + pipeWidth
        ){
            if(
                bird.y - bird.h/2 < p.top ||
                bird.y + bird.h/2 > p.bottom
            ){
                return true;
            }
        }
    }
    return false;
}

function flap(){
    bird.velocity = bird.lift;
}

function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    updatePipes();
    updateBird();

    drawPipes();
    drawBird();

    if(collision()){
        location.reload();
        return;
    }

    frame++;
    requestAnimationFrame(loop);
}

// Controls
canvas.addEventListener("click", flap);
document.addEventListener("keydown", e=>{
    if(e.code==="Space" || e.code==="ArrowUp") flap();
});

// Start the game
loop();
</script>

</body>
</html>